//==============       ���ļ����������һά����, �����Ч��      =============//


#include  "matrix.h"
#include  "stdlib.h"
#include  "math.h"
#include "kalman.h"


//============================================================================//
//==                          ʵ�������                                    ==//
//============================================================================//
//==����˵��: m*n�׾����m*n�׾������, ������������ȴ洢                  ==//
//==��ڲ���: *a                ָ��������ָ��                            ==//
//==          *b                ָ���Ҿ����ָ��                            ==//
//==          *c                ָ���������ָ��                          ==//
//==          m                 ��������                                    ==//
//==          n                 ��������                                    ==//
//==���ڲ���: *c                ָ���������ָ��                          ==//
//==����ֵ:   ��                                                            ==//
//============================================================================//
void MatrixAdd(float *a, float *b, float *c, unsigned char m, unsigned char n)
{
    unsigned char i;

    for (i=0; i<m*n; i++)
    {
        c[i] = a[i] + b[i];
    }
}





//============================================================================//
//==                          ʵ�������                                    ==//
//============================================================================//
//==����˵��: m*n�׾����m*n�׾������, ������������ȴ洢                  ==//
//==��ڲ���: *a                ָ��������ָ��                            ==//
//==          *b                ָ���Ҿ����ָ��                            ==//
//==          *c                ָ���������ָ��                          ==//
//==          m                 ��������                                    ==//
//==          n                 ��������                                    ==//
//==���ڲ���: *c                ָ���������ָ��                          ==//
//==����ֵ:   ��                                                            ==//
//============================================================================//
void MatrixMinus(float *a, float *b, float *c, unsigned char m, unsigned char n)
{
    unsigned char i;

    for (i=0; i<m*n; i++)
    {
        c[i] = a[i] - b[i];
    }
}





//============================================================================//
//==                          ʵ�������                                    ==//
//============================================================================//
//==����˵��: m*p�׾����p*n�׾������, ������������ȴ洢                  ==//
//==��ڲ���: *a                ָ��������ָ��                            ==//
//==          *b                ָ���Ҿ����ָ��                            ==//
//==          *c                ָ���������ָ��                          ==//
//==          m                 ���������                                  ==//
//==          p                 ���������(�Ҿ�������)                      ==//
//==          n                 �Ҿ�������                                  ==//
//==���ڲ���: *c                ָ���������ָ��                          ==//
//==����ֵ:   ��                                                            ==//
//============================================================================//
void MatrixMul(float *a, float *b, float *c, unsigned char m, unsigned char p, unsigned char n)
{
    unsigned char i,j,k;                      //ѭ������

    for (i=0; i<m; i++)                       //ɨ��������
    {
        for (j=0; j<n; j++)                     //ɨ��������
        {
            c[i*n+j] = 0.0;
            for (k=0; k<p; k++)
            {
                //���վ���˷��ĸ������
                c[i*n+j] += a[i*p+k] * b[k*n+j];    //a[i*p+k]: ����k��ѭ��,ɨ����a[]����ĵ�i��
                //b[k*n+j]: ����k��ѭ��,ɨ����a[]����ĵ�j��
            }
        }
    }
}





//============================================================================//
//==                            ʵ������ת��                                ==//
//============================================================================//
//==��ڲ���: *a                ָ��ʵ�����ָ��                            ==//
//==          *c                ָ���������ָ��                          ==//
//==          m                 ��������                                    ==//
//==          n                 ��������                                    ==//
//==���ڲ���: *c                ָ���������ָ��                          ==//
//==����ֵ:   ��                                                            ==//
//============================================================================//
void MatrixTrans(float *a, float *c, unsigned char m, unsigned char n)
{
    unsigned char i,j;

    for (i=0; i<n; i++)
    {
        for (j=0; j<m; j++)
        {
            c[i*m+j] = a[j*n+i];      //����m*n�ľ���,i*m+j��ʾi��j�е�Ԫ��; ����n*m�ľ���,i*n+j��ʾi��j�е�Ԫ��
        }
    }
}





//============================================================================//
//==                          ʵ����������ʽ1                               ==//
//============================================================================//
//==����˵��: ��������ʽչ�������, �Ը߽�����ʽ������                      ==//
//==��ڲ���: *a                ָ��ʵ�����ָ��                            ==//
//==          m                 ��������                                    ==//
//==          n                 ��������                                    ==//
//==���ڲ���: ��                                                            ==//
//==����ֵ:   X                 ����ʽ��ֵ                                  ==//
//============================================================================//
float MatrixDet1(float *a, unsigned char m, unsigned char n)
{
    signed char i, j, k, p, r;                  //ѭ������
    float Temp=1, Temp1=1, S=0, S1=0;           //��������
    float X;                                    //����ʽ��ֵ

    if (n==2)
    {
        for(i=0; i<m; i++)                        //ɨ��������
        {
            for(j=0 ;j<n; j++)                      //ɨ��������
            {
                if((i+j)%2)                           //���������ȵķ���,�Խ���Ԫ���±�֮��Ϊż��
                {
                    Temp1 *= a[i*n+j];
                }
                else
                {
                    Temp  *= a[i*n+j];
                }
            }
        }
        X=Temp-Temp1;
    }
    else
    {
        for (k=0; k<n; k++)                       //��������ʽչ��ʽ�еı�����
        {
            for (i=0,j=k; i<m&&j<n; i++,j++)        //б�߷�����������
            {
                Temp *= a[i*n+j];
            }
            if (m-i)                                //ÿ����˶���m��Ԫ��,������m��Ԫ��,����Ҫ��������
            {
                for (p=m-i,r=m-1; p>0; p--,r--)
                {
                    Temp  *= a[r*n+p-1];
                }
            }
            S += Temp;
            Temp = 1;
        }


        for (k=n-1; k>=0; k--)                    //��������ʽչ��ʽ�еļ���
        {
            for(i=0,j=k; i<m&&j>=0; i++,j--)
            {
                Temp1 *= a[i*n+j];
            }
            if (m-i)
            {
                for(p=m-1,r=i; r<m; p--,r++)
                {
                    Temp1 *= a[r*n+p];
                }
            }
            S1 += Temp1;
            Temp1 = 1;
        }
        X=S-S1;
    }

    return   X;
}





//============================================================================//
//==                           ʵ��������1                                  ==//
//============================================================================//
//==����˵��: ���ݾ�������ʽ����ʵ����������,�Ը߽�����ʽ������           ==//
//==��ڲ���: *a                ָ��ʵ�����ָ��                            ==//
//==          *c                ָ��������ָ��                            ==//
//==          m                 ��������                                    ==//
//==          n                 ��������                                    ==//
//==���ڲ���: *c                ָ��������ָ��                            ==//
//==����ֵ:   ��                                                            ==//
//============================================================================//
void MatrixInv1(float *a, float *c, unsigned char m, unsigned char n)
{
    unsigned char i,j,k,x,y;
    float AB[SYS_ORDER], SP[SYS_ORDER], B[SYS_ORDER];
    float X;                                    //����ʽ��ֵ

    X = MatrixDet1(a, m, n);
    X = 1/X;                                    //����ʽ�ĵ���

    for (i=0; i<m; i++)
    {
        for (j=0; j<n; j++)
        {
            for (k=0; k<m*n; k++)
            {
                B[k] = a[k];                          //��ʼ����������B=a
            }
            for(x=0; x<n; x++)
            {
                B[i*n+x] = 0;                         //i������Ԫ������
            }
            for(y=0; y<m; y++)
            {
                B[m*y+j] = 0;                         //j������Ԫ������
            }
            B[i*n+j] = 1;                           //��ǰ����Ԫ��1
            SP[i*n+j] = MatrixDet1(B,m,n);
            AB[i*n+j] = X*SP[i*n+j];
        }
    }
    MatrixTrans(AB, c, m, n);
}





//============================================================================//
//==                     Gauss-Jordan��ʵ��������                           ==//
//============================================================================//
//==����˵��: ��n�׾���������,�����������ȴ洢; ���������Դ������,����� ==//
//==          ע����ƻ�Դ���������;                                       ==//
//==��ڲ���: *a                ָ��ʵ�����ָ��                            ==//
//==          n                 �������                                    ==//
//==���ڲ���: *a                ָ��������ָ��                            ==//
//==����ֵ:   BOOL              �����ɹ���ʧ��                              ==//
//============================================================================//
unsigned char Gauss_Jordan(float *a, unsigned char n)
{
    signed char i,j,k,l,u,v;
    signed char is[C_ROW];
    signed char js[C_ROW];
    float d,p;

    for (k=0; k<=n-1; k++)
    { d=0.0;
        for (i=k; i<=n-1; i++)
            for (j=k; j<=n-1; j++)
            { l=i*n+j; p=fabs(a[l]);
                if (p>d) { d=p; is[k]=i; js[k]=j;}
            }
        if (d+1.0==1.0)
        {
            return(0);
        }
        if (is[k]!=k)
            for (j=0; j<=n-1; j++)
            { u=k*n+j; v=is[k]*n+j;
                p=a[u]; a[u]=a[v]; a[v]=p;
            }
        if (js[k]!=k)
            for (i=0; i<=n-1; i++)
            { u=i*n+k; v=i*n+js[k];
                p=a[u]; a[u]=a[v]; a[v]=p;
            }
        l=k*n+k;
        a[l]=1.0/a[l];
        for (j=0; j<=n-1; j++)
            if (j!=k)
            { u=k*n+j; a[u]=a[u]*a[l];}
        for (i=0; i<=n-1; i++)
            if (i!=k)
                for (j=0; j<=n-1; j++)
                    if (j!=k)
                    { u=i*n+j;
                        a[u]=a[u]-a[i*n+k]*a[k*n+j];
                    }
        for (i=0; i<=n-1; i++)
            if (i!=k)
            { u=i*n+k; a[u]=-a[u]*a[l];}
    }
    for (k=n-1; k>=0; k--)
    { if (js[k]!=k)
            for (j=0; j<=n-1; j++)
            { u=k*n+j; v=js[k]*n+j;
                p=a[u]; a[u]=a[v]; a[v]=p;
            }
        if (is[k]!=k)
            for (i=0; i<=n-1; i++)
            { u=i*n+k; v=i*n+is[k];
                p=a[u]; a[u]=a[v]; a[v]=p;
            }
    }

    return(1);
}





//============================================================================//
//==                            ����A*B*A'                                  ==//
//============================================================================//
//==��ڲ���: *a                ָ��ʵ�����ָ��                            ==//
//==          *b                ָ��ʵ�����ָ��                            ==//
//==          *c                ָ���������ָ��                          ==//
//==          n                 ����Ľ���                                  ==//
//==���ڲ���: *c                ָ���������ָ��                          ==//
//==����ֵ:   ��                                                            ==//
//============================================================================//
void MatrixCal1(float *a, float *b, float *c, unsigned char n)
{
    float Temp1[4] = {0};
    float Temp2[4] = {0};

    MatrixMul(a, b, Temp1, n, n, n);
    MatrixTrans(a, Temp2, n, n);
    MatrixMul(Temp1, Temp2, c, n, n, n);
}





//============================================================================//
//==                            ����A*B*A'                                  ==//
//============================================================================//
//==��ڲ���: *a                ָ��ʵ�����ָ��                            ==//
//==          *b                ָ��ʵ�����ָ��                            ==//
//==          *c                ָ���������ָ��                          ==//
//==          m                 a���������                                 ==//
//==          n                 a���������                                 ==//
//==���ڲ���: *c                ָ���������ָ��                          ==//
//==����ֵ:   ��                                                            ==//
//============================================================================//
void MatrixCal2(float *a, float *b, float *c, unsigned char m, unsigned char n)
{
    float Temp1[2] = {0};
    float Temp2[2] = {0};

    MatrixMul(a, b, Temp1, m, n, n);
    MatrixTrans(a, Temp2, m, n);
    MatrixMul(Temp1, Temp2, c, m, n, m);
}

